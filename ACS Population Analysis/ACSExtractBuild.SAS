*-------------------------------------------------------------------*
 *  Author:  Fan Xiong            <fanxiong0728@gmail.com>           *
*-------------------------------------------------------------------*

/*This SAS program uses a standard age-population estimate extract from the U.S. Census Bureau 
and creates census tract population estimates for epidemiological analysis*/

/*SPECIFY THE LOCATION OF YOUR EXCEL ACS FILE*/
%LET ACS15 = C:\TEMP\KTRACS BACKUP\ACS FILES\2015_5_year_ACS_censustract_KANSAS;
%LET ACS10 = C:\TEMP\KTRACS BACKUP\ACS FILES\2010_5_year_ACS_censustract_KANSAS;

/*USE FORMAT TO RECODE COLUMN NUMBERS INTO AGE GROUP*/
PROC FORMAT; 
VALUE CENSUSAGE 
1 = "00-04 Years" 2 = "05-09 Years" 
3 = "10-14 Years" 4 = "15-17 Years" 5="18-19 Years" 
6="20 Years" 7 = "21 Years" 8 = "22 to 24 Years"
9="25 to 29 Years" 10="30 to 34 Years" 11="35 to 39 Years" 12 = "40 to 44 Years" 13="45 to 49 Years" 
14="50 to 54 years"
15="55 to 59 years"
16="60 and 61 years"
17="62 to 64 years"
18="65 and 66 years"
19="67 to 69 years"
20="70 to 74 years"
21="75 to 79 years"
22="80 to 84 years"
23="85 years +"
;

VALUE CENSUS5AGE 
1 = "00-04 Years" 2 = "05-09 Years" 
3 = "10-14 Years" 4-5= "15-19 Years" 
6-8="20-24 Years"
9="25-29 Years" 
10="30-34 Years" 
11="35-39 Years" 
12="40-44 Years" 
13="45-49 Years" 
14="50-54 years"
15="55-59 years"
16-17="60-64 years"
18-19="65-69 years"
20="70-74 years"
21="75-79 years"
22="80-84 years"
23="85 years and over"
;
RUN;

/*IMPORT ACS Census Tract and County ID*/
PROC IMPORT DATAFILE="&ACS15\ACS_15_5YR_B01001_with_ann.xls" OUT=ACSCENSUS1115 REPLACE;
RUN;

DATA SPACE.ACSCENSUS1115_CLEAN (KEEP=DATA GEO_id GEO_id2 GEO_display_label STATEFIPS COUNTYFIPS COUNTY TRACTID Tract MALE FEMALE ageflag AGEG);
SET ACSCENSUS1115;
length DATA $35.;
/*ACS Survey Years*/
DATA="2011-2015 ACS 5-Year Census Tract";

/*create variables*/
length DATA $32. AGEG $22. COUNTY $22. STATEFIPS $2. COUNTYFIPS $3. TRACTID $6.;
/*Kansas State Fips*/
STATEFIPS=TRIM(SUBSTR(GEO_id,10,2));
/*Kansas County Fips*/
COUNTYFIPS=TRIM(SUBSTR(GEO_id,12,3));
/*Kansas County Name*/
COUNTY=TRIM(TRIM(SCAN(GEO_display_label,2,",")));
/*Kansas Census Tract ID (2010 Census)*/
TRACTID=TRIM(SUBSTR(GEO_id,15,6));
Tract=TractID*1;
/*SPECIFY COLUMNS FOR POPULATION ESTIMATES*/
ARRAY SEXAGE (2,23) HD01_VD03-HD01_VD25 HD01_VD27-HD01_VD49;
ARRAY GROUPS (2) MALE FEMALE;
	/*gender based array variables: HD01_VD03-HD01_VD25 are males and HD01_VD27-HD01_VD49 are females*/
	do ageflag = 1 to 23;
/*create sex variable: HD01_VD03-HD01_VD25 are males and HD01_VD27-HD01_VD49 are females*/
GROUPS[1] = sexage[1,ageflag];
GROUPS[2] = sexage[2,ageflag];
/*create agegroup variable*/
AGEG=TRIM(PUT(ageflag,CENSUSAGE.));
output;
END;
RUN;

PROC IMPORT DATAFILE="&ACS10\ACS_10_5YR_B01001_with_ann.xls" OUT=ACSCENSUS0610 REPLACE;
RUN;

DATA SPACE.ACSCENSUS0610_CLEAN (KEEP=DATA GEO_id GEO_id2 GEO_display_label STATEFIPS COUNTYFIPS COUNTY TRACTID Tract MALE FEMALE ageflag AGEG);
SET ACSCENSUS0610;
/*ACS Survey Years*/
length DATA $35.;
DATA="2006-2010 ACS 5-Year Census Tract";

/*create variables*/
length DATA $32. AGEG $22. COUNTY $22. STATEFIPS $2. COUNTYFIPS $3. TRACTID $6.;
/*Kansas State Fips*/
STATEFIPS=TRIM(SUBSTR(GEO_id,10,2));
/*Kansas County Fips*/
COUNTYFIPS=TRIM(SUBSTR(GEO_id,12,3));
/*Kansas County Name*/
COUNTY=TRIM(TRIM(SCAN(GEO_display_label,2,",")));
/*Kansas Census Tract ID (2010 Census)*/
TRACTID=TRIM(SUBSTR(GEO_id,15,6));
Tract=TractID*1;
/*SPECIFY COLUMNS FOR POPULATION ESTIMATES*/
ARRAY SEXAGE (2,23) HD01_VD03-HD01_VD25 HD01_VD27-HD01_VD49;
ARRAY GROUPS (2) MALE FEMALE;
	/*gender based array variables: HD01_VD03-HD01_VD25 are males and HD01_VD27-HD01_VD49 are females*/
	do ageflag = 1 to 23;
/*create sex variable: HD01_VD03-HD01_VD25 are males and HD01_VD27-HD01_VD49 are females*/
GROUPS[1] = sexage[1,ageflag];
GROUPS[2] = sexage[2,ageflag];
/*create agegroup variable*/
AGEG=TRIM(PUT(ageflag,CENSUSAGE.));
output;
END;
RUN;

PROC SUMMARY DATA=SPACE.ACS0615 NOPRINT THREADS CHARTYPE;
CLASS DATA STATEFIPS   / ascending;
TYPES DATA*STATEFIPS;
OUTPUT OUT=SPACE.ACS0615STATE (DROP=_TYPE_ _FREQ_) 
SUM(MALE FEMALE) = MALE FEMALE;
RUN;

options obs=max compress=yes;
DATA SPACE.ACS0615;
SET SPACE.ACSCENSUS0610_CLEAN  SPACE.ACSCENSUS1115_CLEAN;
AGEGROUP2=TRIM(PUT(ageflag,CENSUS5AGE.)); 
PROC SUMMARY DATA=SPACE.ACS0615 NOPRINT THREADS CHARTYPE;
CLASS DATA GEO_id2 STATEFIPS COUNTYFIPS TRACTID Tract AGEGROUP2  / ascending;
TYPES DATA*GEO_id2*STATEFIPS*COUNTYFIPS*TRACTID*Tract*AGEGROUP2;
OUTPUT OUT=SPACE.ACS0615B (DROP=_TYPE_ _FREQ_) 
SUM(MALE FEMALE) = MALE FEMALE;
RUN;
 
PROC TRANSPOSE DATA=SPACE.ACS0615B OUT=SPACE.ACS0615C1 PREFIX=MAGE;
BY DATA GEO_id2 STATEFIPS COUNTYFIPS TRACTID Tract;
VAR MALE;
RUN; 

PROC TRANSPOSE DATA=SPACE.ACS0615B OUT=SPACE.ACS0615C2 PREFIX=FAGE;
BY DATA GEO_id2 STATEFIPS COUNTYFIPS TRACTID Tract;
VAR FEMALE;
RUN; 

PROC SQL NOPRINT;
CREATE TABLE SPACE.ACS06015ALL as select a.*, b.*
FROM SPACE.ACS0615C1 as a left join SPACE.ACS0615C2 as b on a.GEO_id2=b.GEO_id2 and a.data=b.data;
QUIT;

PROC SQL NOPRINT;
create table space.ACSPCSA1115 as select a.*, b.*,c.*, TRIM(UPCASE(SCAN(ZIPCITY(b.Z1),1,","))) as SASCITYNAME FORMAT=$35.
FROM SPACE.ACS06015ALL (WHERE=(DATA="2011-2015 ACS 5-Year Census Tract")) as a 
							left join SPACE.Censustractziplatlong as b on a.GEO_id2=b.GEO_id2
							left join SPACE.PCSA as c on a.GEO_id2=b.GEO_id2=c.tractid AND (COMPRESS(UPCASE(SCAN(ZIPCITY(b.Z1),1,","))) = UPCASE(COMPRESS(SUBSTR(Primary_Care_Service_Area__PCSA_,6,length(Primary_Care_Service_Area__PCSA_)))));
QUIT;


DATA BUILD.ACSPOPDATA;
SET SPACE.Acs06015all;
TOTALFEMALE=FAGE1+FAGE2+FAGE3+FAGE4+FAGE5+FAGE6+FAGE7+FAGE8+FAGE9+FAGE10+FAGE11+FAGE12+FAGE13+FAGE14+FAGE15+FAGE16+FAGE17+FAGE18;
TOTALMALE=MAGE1+MAGE2+MAGE3+MAGE4+MAGE5+MAGE6+MAGE7+MAGE8+MAGE9+MAGE10+MAGE11+MAGE12+MAGE13+MAGE14+MAGE15+MAGE16+MAGE17+MAGE18;
TOTALPOP=TOTALFEMALE+TOTALMALE;
PROC SUMMARY DATA=BUILD.ACSPOPDATA THREADS CHARTYPE NOPRINT;
CLASS STATEFIPS DATA TRACTID / groupinternal;
TYPES STATEFIPS*DATA*TRACTID;
OUTPUT OUT=BUILD.ACSPOPDATATRACT
(DROP=_TYPE_ _FREQ_) 
SUM(&CENSUSTRACTPOP TOTALFEMALE TOTALMALE TOTALPOP ) = &CENSUSTRACTPOP TOTALFEMALE TOTALMALE TOTALPOP;
RUN;

PROC SQL NOPRINT;
CREATE TABLE BUILD.ACSPCAPOPALL AS SELECT a.*, b.* 
FROM BUILD.ACSPCSACITYZIP  as a,  BUILD.ACSPOPDATATRACT as b
WHERE a.STATEFIPS=b.STATEFIPS and a.DATA=b.DATA and a.TRACTID=b.TRACTID;
QUIT;

PROC FREQ DATA=BUILD.ACSPCAPOPALL NOPRINT;
TABLES STATEFIPS*TRACTID*Z1*SASCITYNAME / OUT=BUILD.CITYTRACTDUP ;
RUN;

PROC SQL;
SELECT DISTINCT TRACTID FROM BUILD.CITYTRACTDUP WHERE COUNT GE 2;
QUIT;

PROC FREQ DATA=BUILD.CITYTRACTDUP NOPRINT;
TABLES STATEFIPS*TRACTID*Z1*SASCITYNAME / OUT=BUILD.CITYTRACTDUP2 ;
RUN;
